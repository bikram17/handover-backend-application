name: Deploy to Droplet

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          ssh -tt -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 root@${{ secrets.DROPLET_HOST }} << 'EOF'
            echo "âœ… SSH is working"
            hostname
            whoami
            ls -la /root
          EOF

      - name: Deploy via SSH
        run: |
          ssh -tt -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 root@${{ secrets.DROPLET_HOST }} << 'EOF'
            set -ex

            echo "ðŸ“ SSH connected to remote machine"

            echo "ðŸ“ Navigating to app directory..."
            cd /root/app || (git clone https://github.com/bikram17/betting-app-backend.git /root/app && cd /root/app)

            echo "ðŸ”„ Git sync..."
            git config user.email "github-actions@arenabast.com"
            git config user.name "GitHub Actions"
            git fetch origin production || echo "âš ï¸ Git fetch failed"
            git checkout production || echo "âš ï¸ Git checkout failed"
            git reset --hard origin/production || echo "âš ï¸ Git reset failed"
            git clean -fd || echo "âš ï¸ Git clean failed"

            echo "âš™ï¸ Building Spring Boot project..."
            ./mvnw clean package -DskipTests || echo "âš ï¸ Maven build failed"

            echo "ðŸ›‘ Stopping existing Docker containers..."
            docker-compose down || echo "âš ï¸ docker-compose down failed"

            echo "ðŸ”§ Rebuilding containers..."
            docker-compose build --no-cache || echo "âš ï¸ docker-compose build failed"

            echo "ðŸš€ Starting containers..."
            docker-compose up -d || echo "âš ï¸ docker-compose up failed"

            echo "âœ… Deployment successful"
          EOF